<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PiPo Ducky</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #2c2f33;
      color: #f0f0f0;
      display: flex;
      flex-direction: column;
    }

    main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      background-color: #23272a;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    h1 {
      text-align: center;
      color: #ffcb6b;
    }

    textarea {
      background-color: #2c2f33;
      color: #f0f0f0;
      border: none;
      border-radius: 5px;
      padding: 10px;
      font-family: monospace;
      height: 250px;
      resize: vertical;
    }

    button {
      background-color: #ffcb6b;
      border: none;
      color: black;
      padding: 10px;
      margin-top: 10px;
      font-size: 1rem;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #e6b64d;
    }

    footer {
      text-align: center;
      padding: 10px;
      font-size: 0.9em;
      color: #ccc;
      background-color: #23272a;
    }

    footer a {
      color: #ffcb6b;
      text-decoration: none;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: #2f3136;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      max-height: 80%;
      overflow-y: auto;
    }

    .script-item {
      background: #40444b;
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
    }

    .script-item:hover {
      background: #50545b;
    }

    .title { font-weight: bold; color: #ffcb6b; }
    .desc { font-size: 0.9em; color: #ccc; }

    .close-btn {
      float: right;
      color: #aaa;
      font-size: 1.5em;
      cursor: pointer;
    }

    .close-btn:hover {
      color: white;
    }
  </style>
</head>
<body>
  <main>
    <div class="container">
      <h1>PiPo Ducky</h1>
      <button onclick="openScriptModal()">ðŸ—‚ Load Script</button>
      <textarea id="payload" placeholder="Write or load script here..."></textarea>
      <button onclick="runPayload()">â–¶ Run Script</button>
    </div>

    <div class="modal" id="scriptModal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeScriptModal()">&times;</span>
        <h2>Available Scripts</h2>
        <div id="scriptList">Loading...</div>
      </div>
    </div>
  </main>

  <footer>
    &copy; <span id="currentYear"></span> StuffzEZ |
    <a href="https://github.com/StuffzEZ/PiPo-Ducky" target="_blank">GitHub</a>
    <br>
    &copy; <span id="currentYear2"></span> majdsassi |
    <a href="https://github.com/majdsassi/Pico-WIFI-Duck" target="_blank">GitHub</a>
    <br>
    <a target="_blank">With Help From AI For Refining Code</a>
  </footer>

  <script>
    function runPayload() {
      const payload = document.getElementById("payload").value;
      fetch("/api/", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ content: payload })
      })
      .then(res => res.json())
      .then(data => console.log(data))
      .catch(err => alert("Failed to send payload:\n" + err));
    }

    function openScriptModal() {
      document.getElementById("scriptModal").style.display = "flex";
      fetchScripts();
    }

    function closeScriptModal() {
      document.getElementById("scriptModal").style.display = "none";
    }

    async function fetchScripts() {
      const listDiv = document.getElementById("scriptList");
      listDiv.innerHTML = "Loading...";

      try {
        const res = await fetch("/scripts");
        const { scripts } = await res.json();
        listDiv.innerHTML = "";

        for (const file of scripts) {
          const fileRes = await fetch(`/scripts/${file}`);
          const content = await fileRes.text();

          const titleMatch = content.match(/^#T>\s*(.*)/m);
          const descMatch = content.match(/^#D>\s*(.*)/m);

          const title = titleMatch ? titleMatch[1] : file;
          const desc = descMatch ? descMatch[1] : file;

          const btn = document.createElement("div");
          btn.className = "script-item";
          btn.onclick = () => {
            document.getElementById("payload").value = content;
            closeScriptModal();
          };

          btn.innerHTML = `<div class="title">${title}</div><div class="desc">${desc}</div>`;
          listDiv.appendChild(btn);
        }

        if (scripts.length === 0) {
          listDiv.innerHTML = "<p>No scripts found in /scripts.</p>";
        }
      } catch (e) {
        listDiv.innerHTML = "<p>Error loading scripts.</p>";
        console.error(e);
      }
    }

    document.getElementById("currentYear").textContent = new Date().getFullYear();
    document.getElementById("currentYear2").textContent = new Date().getFullYear();
  </script>
</body>
</html>
